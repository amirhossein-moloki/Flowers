# برنامهٔ خودکار اعمال تغییرات روی پروژه (برای مصرف AI)

**هدف:** این فایل را به یک عامل هوش مصنوعی می‌دهیم تا یکی‌یکی تغییراتِ اولویت‌بندی‌شده را روی پروژه‌ی هدف اعمال کند. عامل به‌صورت کامل توانایی دسترسی به کد را دارد (از طریق کلون کردن مخزن). این دستورالعمل‌ها طوری طراحی شده که کمترین اختلال را به فرانت وارد کند و فرآیندها قابل ردیابی و برگشت‌پذیر باشند.

---

## دستورالعمل کلی برای عامل

1. روی ماشینِ ایزوله یا محیط CI که دسترسی به مخزن دارد کار کن. از محیط توسعهٔ محلی به‌عنوان محیطِ اصلی استفاده نکن.
2. مخزن را کلون کن: `git clone <REPO_URL>` (اینجا `<REPO_URL>` را با آدرس واقعی جایگزین کن).
3. وارد شاخهٔ پیش‌فرض شو: `cd <repo>` و `git checkout main` (یا `master` طبق سیاست پروژه).
4. برای هر تغییر، یک شاخهٔ جدید بساز با نام الگوی: `chore/ai/<seq>-<short-task-name>`, مثال: `chore/ai/01-fix-admin-withdrawal-perm`.
5. قبل از اعمال تغییر، `pytest` یا اسکریپت تست پروژه را اجرا کن تا وضعیت پایه را ثبت کنی. خروجی تست را لاگ کن.
6. تغییر را اعمال کن، تست‌ها را دوباره اجرا کن و موقتاً روی یک دیتابیس محلی یا staging اجرا کن. اگر مایگریشن لازم داشت، `makemigrations` و `migrate` را تولید کن اما قبل از اجرای migration روی production با گزینهٔ safe/CONCURRENTLY هماهنگ کن.
7. Commit با پیام ساختاریافته بساز: `git commit -am "<PRIORITY>: <short summary> (#AI)`". سپس `git push origin <branch>`.
8. PR در پلتفرم پروژه بساز (GitHub/GitLab/Bitbucket) با template که در پایین آمده.
9. در PR توضیح بده که تغییر چه تأثیری روی فرانت دارد و چه کارهایی برای استقرار لازم است.
10. پس از merge، اگر migration یا دستور SQL طولانی لازم است، اجرا را با هماهنگی DBA و با استفاده از دستورالعمل‌های rollout در قسمتی که می‌آید ادامه بده.

---

## جدول تغییرات (یکی‌یکی اعمال شود)

| شماره | اولویت | آیتم | تاثیر روی فرانت | تلاش | فایل/نقاط تغییر اصلی | دستورالعمل خلاصه اجرا |
|---:|---|---|---|---:|---|---|
| 1 | بحرانی | اصلاح permission برای AdminWithdrawalRequestViewSet | بسیار کم (فقط محدودسازی ادمین) | S | `wallet/views.py` | در کلاس مربوطه `permission_classes = [IsAdminUser]` بگذار. تست دسترسی اضافه کن. |
| 2 | بالا | افزودن ایندکس‌های DB برای فیلدهای پرتکرار | کم (بدون تغییر API) | M | مدل‌ها: `transactions`, `tournaments`, ... (`models.py`) | به فیلدهای پراستفاده `db_index=True` اضافه کن و `makemigrations` تولید کن. در DB تولیدی برای جدول‌های بزرگ از `CREATE INDEX CONCURRENTLY` استفاده کن. |
| 3 | بالا | اضافه‌کردن نسخه‌بندی API (URLPathVersioning) | بسیار کم اگر مسیرهای قدیمی نگه داشته شوند | M | `settings.py`, `urls.py` | `REST_FRAMEWORK['DEFAULT_VERSIONING_CLASS']='rest_framework.versioning.URLPathVersioning'`، مسیرها را زیر `/api/v1/` نیز mount کن. تست compatibility بنویس. |
| 4 | متوسط | پیاده‌سازی Idempotency برای endpointهای حساس | کم — فرانت می‌تواند بدون تغییر کار کند | M | تغییر در viewها/میان‌افزار و Redis | پیاده‌سازی پشتیبانی از هدر `Idempotency-Key` با ذخیرهٔ پاسخ در Redis و بازگرداندن آن در تکرار. تست concurrency اضافه کن. |
| 5 | متوسط | استخراج منطق پیچیده از viewها به سرویس‌ها | هیچ تاثیر API (اگر signature حفظ شود) | M | `tournaments/views.py` -> `services/tournaments.py` | منطق `join` و دیگر مسیرهای پیچیده را به توابع سرویس منتقل کن و unit test برای سرویس‌ها بنویس. |
| 6 | کم | اضافه‌کردن middleware لاگینگ درخواست/پاسخ | ندارد | S–M | `middleware/request_logging.py`, تنظیم logger | middleware ای اضافه کن که method/path/status/latency/user-id را لاگ کند. داده‌های حساس را فیلتر کن. |
| 7 | کم | افزودن exporter متریک (Prometheus) | ندارد | M | فایل `metrics.py`، config | export نقاط: request_count, request_latency_seconds, celery_queue_length. تست endpoint `/metrics`. |
| 8 | کم | افزایش تست‌های API برای قراردادهای حیاتی | ندارد | M | `tests/` | integration tests برای login, tournament list/join, wallet/deposit بنویس. افزودن به CI. |

---

## الگوی PR (قالبی که باید استفاده شود)

**عنوان PR:** `<Priority> - <Short summary> (#AI)`

**توضیحات:**
- خلاصهٔ تغییرات
- فایل‌های تغییر یافته
- تاثیر روی فرانت: (None / Low / Requires Coordination)
- تست‌های اجراشده و خروجی آن‌ها (ضمیمهٔ لاگ)
- مراحلی که برای استقرار لازم است (migration/DB index/maintenance window)
- rollback plan

**چک‌لیست قبل از merge:**
- [ ] تست‌های واحد و integration محلی سبز
- [ ] review از یک توسعه‌دهندهٔ backend گرفته شده
- [ ] اگر migration دارد، SQL یا مایگریشن امن آماده شده
- [ ] برای تغییرات با تاثیر روی فرانت، اطلاع‌رسانی در کانال تیم فرانت انجام شده

---

## الگوهای commit و نام شاخه

- نام شاخه: `chore/ai/<NN>-<short-name>` (NN ترتیب اجرا)
- پیام commit: `<Priority>: <short summary> (#AI)`

---

## دستورات مفید و نکات فنی

- اجرای تست‌ها: `pytest -q` یا دستور متعارف پروژه.
- تولید مایگریشن: `python manage.py makemigrations` و سپس `python manage.py migrate` (برای production، اگر جدول بزرگ است از `CREATE INDEX CONCURRENTLY` استفاده کن).
- اجرای سرور محلی برای بررسی سریع: `./manage.py runserver` یا کانتینر داکر پروژه.
- اجرای دستور SQL concurrent برای ایندکس بزرگ:

```sql
-- مثال برای Postgres
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_transaction_type ON app_transaction(transaction_type);
```

- اضافه‌کردن ایندکس به مدل و تولید مایگریشن: در `models.py` فیلد را به `db_index=True` بروزرسانی کن و سپس `makemigrations`.

---

## سناریو rollout برای ایندکس روی جدول بزرگ (Postgres)

1. در محیط staging تست کن و زمان اجرای کوئری‌ها را ثبت کن.
2. در production، ایندکس را با `CREATE INDEX CONCURRENTLY` بساز تا قفل طولانی ایجاد نشود.
3. بعد از ایجاد ایندکس، رکوردهای مانیتورینگ latency را بررسی کن.
4. اگر نیاز شد، ایندکس قدیمی/غیرضروری را حذف کن (نیز با CONCURRENTLY).

---

## امنیت و ملاحظات حساسیت داده

- لاگ‌ها را از لاگ کردن فیلدهای حساس (مانند شماره کارت، توکن‌ها، فیلدهای شخصی حساس) منع کن.
- تمام تغییرات مربوط به احراز هویت و تراکنش‌ها را ابتدا در staging به‌خوبی تست کن.

---

## اقدام بعدی پیشنهادی برای توالی اجرای تغییرات

1. اصلاح permission (ردیف 1)
2. ایندکس‌ها (ردیف 2)
3. نسخه‌بندی API (ردیف 3)
4. لاگینگ + متریک‌ها (ردیف 6 و 7)
5. استخراج منطق به سرویس‌ها (ردیف 5)
6. Idempotency (ردیف 4)
7. گسترش تست‌ها (ردیف 8)

---

### نکتهٔ نهایی
این فایل برای عامل خودکار طراحی شده است. عامل باید هر مرحله را در یک شاخهٔ جدا انجام دهد، لاگ‌ها و خروجی تست‌ها را ضمیمه PR کند و هر تغییری که ممکن است بر قرارداد API تأثیر بگذارد را با تیم فرانت هماهنگ کند.

موفق باشی! اگر می‌خواهی من برایت یک PR نمونه یا diff برای اولین آیتم (اصلاح permission) تولید کنم، بگو تا همان‌جا برات آماده کنم.